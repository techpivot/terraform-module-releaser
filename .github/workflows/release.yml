name: Release

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]
    branches:
      - main

jobs:
  merge-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # To publish tags and to publish GitHub release

    if: |
      startsWith(github.event.pull_request.title, 'chore(release):') &&
      contains(github.event.pull_request.body, '<!-- RELEASE-NOTES-MARKER-START -->') &&
      github.event.pull_request.user.login == 'github-actions[bot]'
    #&&
    #github.event.pull_request.merged == true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get all history
          fetch-tags: true

      - name: Extract version from PR body
        id: extract-version
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const body = context.payload.pull_request.body;
            const versionMatch = body.match(/<!-- RELEASE-NOTES-VERSION: ([0-9]+\.[0-9]+\.[0-9]+) -->/);
            if (versionMatch) {
              return versionMatch[1];
            }
            throw new Error('Version not found in PR body');

      - name: Extract release notes from PR body
        id: extract-release-notes
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const body = context.payload.pull_request.body;
            const startMarker = '<!-- RELEASE-NOTES-MARKER-START -->';
            const startIndex = body.indexOf(startMarker);
            if (startIndex === -1) {
              throw new Error('Release notes start marker not found in PR body');
            }
            // Start from right after the marker
            const releaseNotes = body.substring(startIndex + startMarker.length).trim();
            console.log('Extracted release notes:');
            console.log(releaseNotes);
            return releaseNotes;

      - name: Import GPG key
        if: false
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_committer_name: "GitHub Actions"
          git_committer_email: "github-actions@users.noreply.github.com"
          trust_level: 5
          git_tag_gpgsign: true
          #git_push_gpgsign: true
          git_commit_gpgsign: true

      - name: List keys
        run: gpg -K

      - name: GPG Version
        run: gpg --version

          # git config user.name "github-actions[bot]"
        # git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create and push signed tag
        run: |
          # Get the SHA of the latest commit
          #COMMIT_SHA=$(git rev-parse HEAD)

          # Create an annotated and signed tag pointing to the current commit
          git tag "v${{ steps.extract-version.outputs.result }}"
          # $COMMIT_SHA -m "Release v${{ steps.extract-version.outputs.result }}"

          git push origin v${{ steps.extract-version.outputs.result }}

      - name: Create GitHub Release via API
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = `v${{ steps.extract-version.outputs.result }}`;
            const releaseName = tag;
            const body = ${{ toJSON(steps.extract-release-notes.outputs.result) }};

            const release = await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name: tag,
              name: releaseName,
              body,
              draft: false,
              prerelease: false,
              target_commitish: 'main'
            });

            console.log(`Created release: ${release.data.html_url}`);
